name: ğŸ›¡ï¸ ProtecciÃ³n de Ramas

on:
  push:
    branches: [ main, develop ]

# Permisos mÃ­nimos
permissions:
  contents: read
  issues: write

jobs:
  block-direct-push:
    runs-on: ubuntu-latest
    steps:
    - name: âŒ Bloquear push directo a rama protegida
      run: |
        echo "ğŸš« PUSH DIRECTO BLOQUEADO"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âŒ No se permiten pushes directos a las ramas main/develop"
        echo "ğŸ“‹ Proceso correcto:"
        echo "   1. Crear una rama feature/nombre-feature"
        echo "   2. Hacer commits en la rama feature"
        echo "   3. Crear Pull Request hacia develop o main"
        echo "   4. Esperar aprobaciÃ³n y merge"
        echo ""
        echo "ğŸ‘¤ Usuario: ${{ github.actor }}"
        echo "ğŸŒ¿ Rama: ${{ github.ref_name }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Solo permitir al owner hacer pushes directos
        AUTHORIZED_USERS="carlos-2790"
        
        if [[ "$AUTHORIZED_USERS" == *"${{ github.actor }}"* ]]; then
          echo "âœ… Usuario autorizado para push directo: ${{ github.actor }}"
          echo "âš ï¸  ADVERTENCIA: Evita pushes directos, usa PRs cuando sea posible"
          exit 0
        else
          echo "âŒ Usuario NO autorizado para push directo: ${{ github.actor }}"
          exit 1
        fi
    
    - name: ğŸ“ Crear issue de violaciÃ³n (si falla)
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const title = `ğŸš« Push directo bloqueado - ${context.payload.head_commit.message}`;
          const body = `
          ## ğŸ›¡ï¸ ViolaciÃ³n de ProtecciÃ³n de Rama
          
          **Usuario:** @${{ github.actor }}
          **Rama:** \`${{ github.ref_name }}\`
          **Commit:** \`${{ github.sha }}\`
          **Mensaje:** ${{ github.event.head_commit.message }}
          **Fecha:** ${new Date().toISOString()}
          
          ### ğŸ“‹ Proceso Correcto:
          1. Crear rama feature: \`git checkout -b feature/nombre-feature\`
          2. Hacer commits en la rama feature
          3. Push a la rama feature: \`git push origin feature/nombre-feature\`
          4. Crear Pull Request hacia develop o main
          5. Esperar aprobaciÃ³n y merge
          
          ### âš ï¸ AcciÃ³n Requerida:
          - [ ] Revertir el push directo
          - [ ] Crear rama feature apropiada
          - [ ] Crear Pull Request
          
          **Este issue se cerrarÃ¡ automÃ¡ticamente cuando se corrija la violaciÃ³n.**
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['violation', 'branch-protection']
          }); 