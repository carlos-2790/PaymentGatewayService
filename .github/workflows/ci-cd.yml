name: CI/CD Pipeline - Payment Gateway Service

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: '-Dmaven.repo.local=.m2/repository -Xmx1024m'

jobs:
  # ğŸ§ª Job 1: Tests Unitarios
  test:
    name: ğŸ§ª Tests Unitarios
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: â˜• Configurar JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: ğŸ“¦ Cache dependencias Maven
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: ğŸ” Verificar estructura del proyecto
      run: |
        echo "ğŸ“‚ Estructura del proyecto:"
        ls -la
        echo "ğŸ“‚ Contenido de src:"
        ls -la src/ || echo "âŒ Directorio src no encontrado"
        
    - name: âœ… Ejecutar tests unitarios
      run: mvn clean test -B
      
    - name: ğŸ“Š Generar reporte de cobertura
      run: mvn jacoco:report -B
      continue-on-error: true
      
    - name: ğŸ“ˆ Subir resultados de tests
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ github.run_number }}
        path: |
          target/surefire-reports/
          target/site/jacoco/
        retention-days: 30

  # ğŸ” Job 2: AnÃ¡lisis de Calidad
  code-quality:
    name: ğŸ” AnÃ¡lisis de Calidad
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
        
    - name: â˜• Configurar JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: ğŸ“¦ Cache dependencias Maven
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: ğŸ—ï¸ Compilar proyecto
      run: mvn clean compile -B
      
    - name: ğŸ” AnÃ¡lisis estÃ¡tico de cÃ³digo
      run: mvn verify -B
      continue-on-error: true

  # ğŸ—ï¸ Job 3: Build y Empaquetado
  build:
    name: ğŸ—ï¸ Build y Empaquetado
    runs-on: ubuntu-latest
    needs: [test, code-quality]
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: â˜• Configurar JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: ğŸ“¦ Cache dependencias Maven
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: ğŸ—ï¸ Compilar y empaquetar
      run: mvn clean package -DskipTests -B
      
    - name: ğŸ“¦ Subir artefactos
      uses: actions/upload-artifact@v4
      with:
        name: payment-gateway-jar-${{ github.run_number }}
        path: target/*.jar
        retention-days: 30
        
    - name: ğŸ·ï¸ Crear tag de versiÃ³n
      if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
      run: |
        VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "ğŸ·ï¸ VersiÃ³n detectada: $VERSION"

  # ğŸš€ Job 4: Despliegue
  deploy:
    name: ğŸš€ Despliegue
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    # environment: production  # Comentado hasta configurar environments en GitHub
    
    steps:
    - name: ğŸ“¥ Descargar artefactos
      uses: actions/download-artifact@v4
      with:
        name: payment-gateway-jar-${{ github.run_number }}
        
    - name: ğŸš€ Simular despliegue
      run: |
        echo "ğŸ‰ Iniciando despliegue de Payment Gateway Service..."
        echo "ğŸ“¦ Archivos disponibles para despliegue:"
        ls -la *.jar
        echo "âœ… Despliegue completado exitosamente!"
        echo "ğŸŒ AplicaciÃ³n disponible en: https://payment-gateway.ejemplo.com"

  # ğŸ“¢ Job 5: Notificaciones
  notify:
    name: ğŸ“¢ Notificaciones
    runs-on: ubuntu-latest
    needs: [test, code-quality, build, deploy]
    if: always()
    
    steps:
    - name: ğŸ“¢ Notificar resultado del pipeline
      run: |
        echo "ğŸ“Š Resumen del Pipeline:"
        echo "ğŸ§ª Tests: ${{ needs.test.result }}"
        echo "ğŸ” Calidad: ${{ needs.code-quality.result }}"
        echo "ğŸ—ï¸ Build: ${{ needs.build.result }}"
        echo "ğŸš€ Deploy: ${{ needs.deploy.result }}"
        
        if [ "${{ needs.test.result }}" == "success" ]; then
          echo "âœ… Pipeline ejecutado exitosamente!"
        else
          echo "âŒ Pipeline fallÃ³. Revisar logs de tests."
          exit 1
        fi